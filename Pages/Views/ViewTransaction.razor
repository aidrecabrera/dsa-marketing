@page "/transaction_info/{TransactionId:int}"
@using dsa_marketing.Models

<h3>Transaction Information</h3>

@if (transactionInformation != null)
{
    <h1>@transactionInformation.MunicipalityName</h1>
    <h1>@transactionInformation.BarangayName</h1>
    @if (documentInformation != null)
    {
        <h1>@documentInformation.PunongBarangayName</h1>
        <h1>@documentInformation.BarangayTreasurerName</h1>
    }
    else
    {
        <h1>No Punong Barangay</h1>
        <h1>No Barangay Treasurer</h1>
    }

    @if (transactionItems != null && transactionItems.Any())
    {
        <table class="table">
            <thead>
                <tr>
                    <th>Unit</th>
                    <th>Particulars</th>
                    <th>Quantity</th>
                    <th>Cost</th>
                    <th>Amount</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in transactionItems)
                {
                    <tr>
                        <td>@item.UnitName</td>
                        <td>@item.Particulars</td>
                        <td>@item.Quantity</td>
                        <td>@item.Cost</td>
                        <td>@item.Amount</td>
                        <td>
                            @if (itemInEditMode == item)
                            {
                                <button @onclick="SaveEdit">Save</button>
                                <button @onclick="CancelEdit">Cancel</button>
                            }
                            else
                            {
                                <button @onclick="() => EditItem(item)">Edit</button>
                            }
                        </td>
                    </tr>
                    @if (itemInEditMode == item)
                    {
                        <tr>
                            <td>
                                <input @bind="item.UnitName" />
                            </td>
                            <td>
                                <input @bind="item.Particulars" />
                            </td>
                            <td>
                                <input @bind="item.Quantity" />
                            </td>
                            <td>
                                <input @bind="item.Cost" />
                            </td>
                            <td>
                                <input @bind="item.Amount" />
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    }
    else
    {
        <p>No transaction items found.</p>
    }
}
else
{
    <p>No data found for the selected transaction.</p>
}

@code {
    [Parameter]
    public int TransactionId { get; set; }

    private Transaction transactionInformation;
    private TransactionDocuments documentInformation;
    private List<TransactionItem> transactionItems;

    private TransactionItem itemInEditMode;

    [Inject]
    private DsaClusterContext _context { get; set; }

    protected override void OnParametersSet()
    {
        if (TransactionId > 0)
        {
            transactionInformation = _context.Transactions.FirstOrDefault(t => t.TransactionId == TransactionId);

            if (transactionInformation != null)
            {
                documentInformation = _context.TransactionDocuments.FirstOrDefault(d => d.DocumentId == transactionInformation.TransactionId);
                transactionItems = _context.TransactionItems.Where(ti => ti.DocumentId == transactionInformation.TransactionId).ToList();
            }
        }
    }

    void EditItem(TransactionItem item)
    {
        itemInEditMode = item;
    }

    void SaveEdit()
    {
        if (itemInEditMode != null)
        {
            _context.Update(itemInEditMode);
            _context.SaveChanges();
            itemInEditMode = null;
        }
    }

    void CancelEdit()
    {
        itemInEditMode = null;
    }
}
