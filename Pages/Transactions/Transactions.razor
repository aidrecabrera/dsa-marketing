@page "/transactions"
@using Aneta.Data
@using Aneta.Models
@using MudBlazor
@inject NavigationManager Navigation

<PageTitle>Transactions</PageTitle>

<div class="font-inter text-black">
    <div>
        <div class="flex flex-row align-middle justify-between w-full">
            <MudGrid Class="d-flex align-content-center justify-space-between flex-grow-1 pb-3">
                <MudItem Class="d-flex flex-grow-1 align-end">
                    <MudText Typo="Typo.h3" Class="fw-bold font-inter font-bold" Style="@($"color:{Colors.Shades.Black};")">TRANSACTIONS</MudText>
                </MudItem>
                <MudItem Class="w-25">
                    <MudTextField @bind-Value="_searchTransactionInfo" Placeholder="Search" Adornment="Adornment.Start" AdornmentIcon="@Icons.Material.Filled.Search" IconSize="Size.Medium" Class="mt-0 text-white"></MudTextField>
                </MudItem>
            </MudGrid>
        </div>
    </div>
    
    <MudTable Class="rounded-2xl" T="ExistingTransactionsSummary" Items="@_listOfTransactions" Hover="true" @bind-SelectedItem="_selectedItem" Filter="FilterFunc1" Height="70vh" FixedHeader="true">
        <HeaderContent>
            <MudTh>TID</MudTh>
            <MudTh>City/Municipality</MudTh>
            <MudTh>Barangay</MudTh>
            <MudTh>Punong Barangay</MudTh>
            <MudTh>Barangay Treasurer</MudTh>
            <MudTh></MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd>@context.TransactionId</MudTd>
            <MudTd>@context.MunicipalityName</MudTd>
            <MudTd>@context.BarangayName</MudTd>
            <MudTd>@context.PunongBarangayName</MudTd>
            <MudTd>@context.BarangayTreasurerName</MudTd>
            <MudTd DataLabel="View">
                <MudButton @onclick="() => NavigateToTransactionInfo(context.TransactionId)">
                    View Details
                </MudButton>
            </MudTd>
        </RowTemplate>
        <PagerContent>
            <MudTablePager Style="height: 75px" />
        </PagerContent>
    </MudTable>

</div>

@code {
    [Inject]
    private DsaClusterContext? DbContext { get; set; }
    private void NavigateToTransactionInfo(int transactionId)
    {
        Navigation.NavigateTo($"/transaction_info/{transactionId}");
    }

    void CreateNewTransaction()
    {
        Navigation.NavigateTo("/create_transaction");
    }
    
    private string _searchTransactionInfo = "";
    private ExistingTransactionsSummary? _selectedItem = null;
    
    IEnumerable<ExistingTransactionsSummary> _listOfTransactions = new List<ExistingTransactionsSummary>();

    protected override void OnInitialized()
    {
        var unitOfWork = new UnitOfWork(DbContext);
        _listOfTransactions = unitOfWork.ExistingTransactionsSummary?.GetAll().ToList()!;
    }
    
    private bool FilterFunc1(ExistingTransactionsSummary element) => FilterFunc(element, _searchTransactionInfo);

    private bool FilterFunc(ExistingTransactionsSummary element, string searchString)
    {
        if (string.IsNullOrWhiteSpace(searchString))
            return true;
        if (element.BarangayName!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.MunicipalityName!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.PunongBarangayName!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        if (element.BarangayTreasurerName!.Contains(searchString, StringComparison.OrdinalIgnoreCase))
            return true;
        return false;
    }
}